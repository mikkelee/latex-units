\ProvidesPackage{non-decimal-units}[2020/09/07 Macros for displaying and manipulating historical non-decimal units]

% License: CC-BY-SA 4.0
% Author: Mikkel Eide Eriksen <mikkel.eriksen@gmail.com>

\RequirePackage{pgfkeys}

\RequirePackage{etoolbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pgfkeys{/handlers/.store in cs/.code=\pgfkeysalso{%
	\pgfkeyscurrentpath/.code=\csdef{#1}{##1}}%
}

\def\nduset{\pgfqkeys{/non-decimal-units}}

\newif\ifshowvalues
\newif\ifshowunits
\showvaluestrue
\showunitstrue

\nduset{
	show/.is choice,
	show/values/.code={\showvaluestrue\showunitsfalse},
	show/values and units/.code={\showvaluestrue\showunitstrue},
	show/units/.code={\showvaluesfalse\showunitstrue},
	show=values and units,
	aligned value width/.store in cs=ndu@aligned@value@width,
	aligned value width=5em,
}

\newcommand\ndu@setup[2]{%
	% #1 = unit name
	% #2 = further key/value pairs
	\csdef{ndu@#1@levels}{0}%
	\nduset{
		#1/.search also={/non-decimal-units},
		#1/.cd,
		unit separator/.store in cs=ndu@#1@unit@separator,
		unit separator={~},
	}%
	\ndu@setup@level{#1}{0}%
	\ndu@setup@level{#1}{1}%
	\ndu@setup@level{#1}{2}%
	\ndu@setup@level{#1}{3}%
	\ndu@setup@level{#1}{4}%
	\nduset{#1/.cd,#2}%
}

\newcommand\ndu@update@level[2]{%
	% #1 = unit name
	% #2 = number of levels
	\ifnum#2>\csuse{ndu@#1@levels}%
		\csdef{ndu@#1@levels}{#2}%
	\fi%
}

\newcommand\ndu@setup@level[2]{%
	\nduset{
		#1/level #2/.cd,
		display/.code 2 args={%
			% #1 = prefix
			% #2 = suffix
			\csdef{ndu@#1@display@level #2@prefix}{##1}%
			\csdef{ndu@#1@display@level #2@suffix}{##2}%
			\ndu@update@level{#1}{#2}%
		},
	}%
}

\newcommand\ndu@if@level@at@least[3]{%
	\ifnum#2>\csuse{ndu@#1@levels}%
		\relax%
	\else%
		#3%
	\fi%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\nduFormatLevelValue[3]{%
	% #1 = unit name
	% #2 = level
	% #3 = value
	\ifshowunits\csuse{ndu@#1@display@level #2@prefix}\fi%
	\ifshowvalues#3\fi%
	\ifshowunits\csuse{ndu@#1@display@level #2@suffix}\fi%
}

\newcommand\ndu@helper@listjoin[2]{%
	\begingroup%
	\edef\ndu@nextdelim{#1}%
	\edef\ndu@delim{}%
	\renewcommand*\do[1]{%
		\ndu@delim##1\edef\ndu@delim{\ndu@nextdelim}%
	}%
	\dolistloop{#2}%
	\endgroup%
}

\newcommand\nduFormatValues@helper[3]{%
	\ndu@if@level@at@least{#1}{#2}{\IfValueT{#3}{\ifblank{#3}{}{\listadd{\tmp}{\nduFormatLevelValue{#1}{#2}{#3}}}}}%
}

\newcommand\nduFormatValues@internal[6]{%
	% #1 = unit name
	% #2-6 = values
	\nduFormatValues@helper{#1}{0}{#2}%
	\nduFormatValues@helper{#1}{1}{#3}%
	\nduFormatValues@helper{#1}{2}{#4}%
	\nduFormatValues@helper{#1}{3}{#5}%
	\nduFormatValues@helper{#1}{4}{#6}%
	\ndu@helper@listjoin{\csuse{ndu@#1@unit@separator}}{\tmp}%
}

\NewDocumentCommand\nduFormatValues{ m O{} > { \SplitArgument { 4 } { . } } m }{%
	% #1 = unit name
	% #2 = options
	% #3 = values joined by .
	\begingroup%
	\nduset{#1/.cd,#2}%
	\nduFormatValues@internal{#1}#3%
	\endgroup%
}

\newlength{\ndu@boxwidth}
\newcommand*{\ndu@minwidthbox}[2]{%
	\makebox[{\ifdim#1<\width\width\else#1\fi}][r]{%
		\ifcsstring{genealogy@units@nil@marker}{#2}{%
			\csuse{genealogy@units@nil@replacement}%
		}{%
			#2%
		}%
	}%
}

\newcommand\nduAlignedValues@helper[3]{%
	\ndu@if@level@at@least{#1}{#2}{\ndu@minwidthbox{\csuse{ndu@aligned@value@width}}{\nduFormatLevelValue{#1}{#2}{#3}}}%
}

\newcommand\nduAlignedValues@internal[6]{%
	% #1 = unit name
	% #2-6 = values
	\nduAlignedValues@helper{#1}{0}{#2}%
	\nduAlignedValues@helper{#1}{1}{#3}%
	\nduAlignedValues@helper{#1}{2}{#4}%
	\nduAlignedValues@helper{#1}{3}{#5}%
	\nduAlignedValues@helper{#1}{4}{#6}%
}

\NewDocumentCommand\nduAlignedHeader{ m O{} }{%
	\begingroup%
	\nduset{show=units,#1/.cd,#2}%
	\nduAlignedValues@helper{#1}{0}{}%
	\nduAlignedValues@helper{#1}{1}{}%
	\nduAlignedValues@helper{#1}{2}{}%
	\nduAlignedValues@helper{#1}{3}{}%
	\nduAlignedValues@helper{#1}{4}{}%
	\endgroup%
}

\NewDocumentCommand\nduAlignedValues{ m O{} > { \SplitArgument { 4 } { . } } m }{%
	% #1 = unit name
	% #2 = options
	% #3 = values joined by .
	\begingroup%
	\nduset{show=values,#1/.cd,#2}%
	\nduAlignedValues@internal{#1}#3%
	\endgroup%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{non-decimal-units.danish}

