% !TEX TS-program = LuaLaTeX-shell-escape
\documentclass[
	a4paper,
	margin=4cm
]{article}

\usepackage{non-decimal-units.preamble}

\title{Non-Decimal Units for \LaTeX}
\author{Mikkel Eide Eriksen\\\href{mailto:mikkel.eriksen@gmail.com}{\texttt{mikkel.eriksen@gmail.com}}}

\nduKeys{
	set aligned for environment=tabular,
	unit depth=skilling,
	unit separator={~}
}

\begin{document}

\maketitle

\section{Preface} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Many historical unit systems were non-decimal. For example, the Danish rigsdaler\footnote{\url{https://en.wikipedia.org/wiki/Danish_rigsdaler}} --- where 1 rigsdaler consists of 16~mark, each again consisting of 16~skilling for a total of 96 skilling per rigsdaler --- was used from 1625 to 1875, when currency was decimalised to the current system of 1 krone = 100 øre.

% https://en.wikipedia.org/wiki/Non-decimal_currency

Units for such measures as length, area, weight, and so on were also often non-decimal, and in fact remain so in the few places of the world that have not made the change to the metric system.

The non-decimal numbers were chosen due to their larger number of division factors, which simplified mental arithmetic --- eg. when sharing an amount of money or dividing goods.

This package enables creation and configuration of such units to facilitate their presentation in textual and tabular contexts, as well as simple arithmetic.

In order to do this, values are divided into \emph{segments}, which are separated by decimal points: for example, the historical Danish monetary value \nduValue{danish rigsdaler}{1.2.3} is entered as \texttt{1.2.3}, which the code then formats appropriately.

Issues can be reported at \url{https://github.com/mikkelee/latex-units/issues} but keep in mind I am not very experienced with \LaTeX{} ;)

\clearpage
\section{Configuration} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The package is configured in the following manner:

\begin{docCommand}
	{usepackage}
	{\oarg{options}\brackets{non-decimal-units}}

Where \meta{options} may contain one or more of the following unit systems. See \cpageref{units:included} for details.

\begin{description}
\item[british] Currencies
\item[danish] Currencies, areas, and weights
\item[german] Currencies
\end{description}

Alternately, one may configure new units via \refCom{nduNewBaseUnit} and \refCom{nduNewUnitGroup}.

\end{docCommand}

\begin{docCommand}
	{nduKeys}
	{\marg{options}}

	Can be used to set options globally (in the preamble) or locally (in a group). See further documentation for possible keys/values.

\end{docCommand}

\clearpage
\section{Usage} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Formatting Values} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The central macro is \docAuxCommand*{nduValue}. It formats values for display and is configurable in a number of ways.

\begin{docCommand}
	{nduValue}
	{\marg{unit group}\oarg{options}\marg{value}}

Formats \meta{value} according to the setup configured for the \meta{unit group}, as well as any provided \meta{options}.

If no special configuration is made, the number of decimal points and the values between them determine how many and which units are displayed. For example, empty values are skipped unless the \refKey{replace nil with} key is set.
	
\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduValue} macro
}
\nduValue{danish rigsdaler}{1.2.3}\\
\nduValue{danish rigsdaler}{1}\\
\nduValue{danish rigsdaler}{.2}\\
\nduValue{danish rigsdaler}{..3}\\
\end{dispExample*}
\end{docCommand}

\clearpage
\subsubsection{Options}
	
\begin{docKeys}[
		doc name = display,
	]{
		{
			doc parameter = {=values only},
		},
		{
			doc parameter = {=formatted},
			doc description = initially \texttt{formatted},
		},
		{
			doc parameter = {=symbols only},
		},
	}

Changes which information is included in the expansion.

Because only present values will be included, \docAuxKey*{display}=\docValue*{symbols only} can be used to list the segment units (though it may be preferable to use \refCom{nduHeader} or \refCom{nduSymbol}).

\begin{dispExample}
\nduValue{danish hartkorn}
	[display=symbols only]
	{0.0.0.0.0}

\nduValue{danish hartkorn}
	[display=values only]
	{0.0...}
\end{dispExample}
\end{docKeys}

\begin{docKey}
	{format}
	{=\marg{...}}
	{initially \docAuxCommand*{VALUE}\docAuxCommand*{nobreakspace}\docAuxCommand*{SYMBOL}}

	Sets how a given base unit should be formatted for display.
	
	The placeholders \docAuxCommand*{VALUE} and \docAuxCommand*{SYMBOL} will be substituted when the value is typeset.
\end{docKey}

\begin{docKeys}
	[]
	{
		{
			doc name = replace nil with,
			doc parameter = {=\meta{...}},
			doc description = {no default, initially empty},
		},
		{
			doc name = treat zero as nil,
			doc description = {initially not set},
		},
	}

The key \docAuxKey*{replace nil with} replaces nil (empty) segments with a custom string.

The key \docAuxKey*{treat zero as nil} replaces 0 with nothing, which in turn means that setting both will replace both zero and nil with the custom string.

\end{docKeys}

\begin{docKey}
	{unit depth}
	{=\meta{unit name}}
	{initially no restriction}
	
	When calculating or displaying a value, only the segments up to and including \meta{unit name} will be considered.
	
	In this document, the depth has been globally set to \texttt{skilling}, but older historical sub-units can be included by locally setting the depth to eg. \texttt{hvid} (or indeed not restricting it globally).
	
	If the \meta{unit name} is not present in the current unit group, it has no effect.
	
\begin{dispExample}
\nduValue{danish rigsdaler}
	[unit depth=skilling]
	{1.2.3.4.5}

\nduValue{danish rigsdaler}
	[unit depth=penning]
	{1.2.3.4.5}
\end{dispExample}
\end{docKey}

\begin{docKey}
	{unit separator}
	{=\meta{...}}
	{initially \docAuxCommand*{nobreakspace}}
	
	When displaying a value, this string will be inserted between each segment.

\begin{dispExample}
\nduValue{danish hartkorn}[
		display=values only,
		unit separator=.
	]
	{1.2.3.4}

\nduValue{danish rigsdaler}
	[unit separator={---}]
	{1.2.3}
\end{dispExample}

\end{docKey}


\clearpage
\section{Tabular Data} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In order to align values in a tabular context, the \docAuxKey*{aligned} key causes \docAuxCommand{nduValue} to wrap each segment in a cell of equal width.

All segments will be included in the headers and cells, whether they contain a value or not (provided \docAuxKey{unit depth} allows it). If no value is provided for the segment, and no nil replacement is specified with the \refKey{replace nil with} key, the cell will be empty.

\begin{docCommand}
	{nduHeader}
	{\marg{unit name}\oarg{options}}
	Convenient header showing the unit symbols. See \cpageref{units:new} for configuration of symbols.
\end{docCommand}

\begin{dispExample*}{
	title=Example of tabular data
}
\begingroup
\nduKeys{
	aligned,
	treat zero as nil,
	replace nil with=---,
}
\begin{tabular}{r r}
	\toprule
	& \nduHeader{danish rigsdaler} \\
	\midrule
	a & \nduValue{danish rigsdaler}{1.2.3} \\
	b & \nduValue{danish rigsdaler}{100.0.0} \\
	c & \nduValue{danish rigsdaler}{.1.} \\
	\bottomrule
\end{tabular}
\endgroup
\end{dispExample*}

\clearpage
\subsection{Options for Tabular Data}

\begin{docKeys}
	[]
	{
		{
			doc name = aligned,
			doc description = {initially not set},
		},
		{
			doc name = set aligned for environment,
			doc description = {initially set for \texttt{tabular}},
		},
	}

	Setting \docAuxKey*{aligned} will format the presently displayed value in aligned cells, desirable in tabular contexts. % TODO

	The \docAuxKey{set aligned for environment} key can be set to an environment name, causing \docAuxKey*{aligned} to automatically be set for those enviroments, using \docAuxCommand*{AtBeginEnvironment}. It can be set multiple times, once for each required environment.

\end{docKeys}

\begin{docKey}
	{cell width}
	{=\meta{length}}
	{initially \texttt{3em}}

Changes the width of each segment.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{cell width} key
}
\begingroup
\nduKeys{
	treat zero as nil,
	cell width=5em,
}
\begin{tabular}{r r}
	\toprule
	& \nduHeader{danish rigsdaler} \\
	\midrule
	a & \nduValue{danish rigsdaler}{1.2.3} \\
	b & \nduValue{danish rigsdaler}{100..} \\
	c & \nduValue{danish rigsdaler}{.1.} \\
	\bottomrule
\end{tabular}
\endgroup
\end{dispExample*}
\end{docKey}

\clearpage
\section{Arithmetical Operations} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Basic arithmetic functions can be used to build a result for display. This is done by converting the value to an internal representation and storing it in a variable. The first time a variable is used, it is assumed that the value is 0.

Results can be gathered in two ways, either manually via the \docAuxCommand*{nduMath} macro, or automatically via the \docAuxKey{add to variable} and \docAuxKey{subtract from variable} keys, the latter being especially suitable in tabular contexts.

\begin{docCommand}
	{nduMath}
	{\marg{unit name}\oarg{options}\marg{variable}\marg{operator}\marg{value}}

	The first arguments of \docAuxCommand*{nduMath} are identical to those of the \refCom{nduValue} macro. In addition, it has \meta{variable} and \meta{operator} (one of \texttt{+ - * /}) arguments. The command does not expand to any output.

	Note that mixing units in the same variable is not currently supported, and will likely give incorrect results.

\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduMath} macro
}
\nduMath{danish rigsdaler}{example 1}{+}{0.0.10}
\nduMath{danish rigsdaler}{example 1}{+}{..8}
\nduMath{danish rigsdaler}{example 1}{+}{0.2}
\nduMath{danish rigsdaler}{example 1}{+}{0.5.1}
% there is no output, the result 1.2.3
% will be seen in the following example.
\end{dispExample*}

\end{docCommand}

\begin{docCommand}
	{nduResult}
	{\marg{unit name}\oarg{options}\marg{variable}}

	The \docAuxCommand*{nduResult} macro takes a stored \meta{variable} and formats it via \meta{options} for display in the same way as \refCom{nduValue}.

\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduResult} macro
}
\begingroup
\nduKeys{
	aligned,
	cell width=3em,
}
\nduHeader{danish rigsdaler}\\
\nduResult{danish rigsdaler}{example 1}
\endgroup
\end{dispExample*}

\end{docCommand}

\clearpage
\subsection{Options for Arithmetical Operations}

\begin{docKeys}
	[
		doc parameter = {=\meta{...}},
	]
	{
		{
			doc name = add to variable,
		},
		{
			doc name = subtract from variable,
		},
	}

Setting either of these keys will cause all uses of \docAuxCommand*{nduValue} in the current group to be added to or subtracted from the variable with the given name. It can of course also be set on individual invocations of the command.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{add to variable} key
}
\begingroup
\nduKeys{
	replace nil with=---,
	add to variable=example 2
}
\begin{tabular}{r r}
	\toprule
	& \nduHeader{danish rigsdaler} \\
	\midrule
	a & \nduValue{danish rigsdaler}{1.2.3} \\
	b & \nduValue{danish rigsdaler}{100.1.} \\
	\bottomrule
	total & \nduResult{danish rigsdaler}{example 2} \\ % = 101.3.3
\end{tabular}
\endgroup
\end{dispExample*}

Results are global and remain accessible outside the group:
\begin{dispExample}
\nduResult{danish rigsdaler}{example 2}

And let's add add an additional 15 skilling:

\nduMath{danish rigsdaler}{example 2}{+}{0.0.15}
\nduResult{danish rigsdaler}{example 2} % = 101.4.2
\end{dispExample}
\end{docKeys}

\begin{docKey}
	{normalize}
	{}
	{initially not set}

Reformats an amount, which is useful for quick conversions.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{normalize} key
}
100 skilling equal
\nduValue{danish rigsdaler}[normalize]{..100} % 1.0.4
\end{dispExample*}
\end{docKey}

\clearpage
\section{Accessing Information About Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{docCommand}
	{nduSymbol}
	{\marg{unit name}}
	Expands to the symbol of the given base unit.
	
	Set by \refKey{units:symbol}.
\end{docCommand}

\begin{docCommand}
	{nduFactor}
	{\marg{unit name}\marg{unit name}}
	Expands to the conversion between two base units.

	Set by \refKey{units:factor}.
\begin{dispExample}
That is, 1 \nduSymbol{rigsdaler} consists of
\nduFactor{rigsdaler}{skilling} \nduSymbol{skilling}.
\end{dispExample}
\end{docCommand}

\clearpage
\section{Creating New Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{units:new}
If the included units are not suitable, more can be created. Pull requests are also welcome at \url{https://github.com/mikkelee/latex-units}.

\begin{docCommand}
	{nduNewBaseUnit}
	{\marg{unit name}\marg{key/value pairs}}
	
Creates a new base unit. It must contain at least a \docAuxKey{symbol}, but a \docAuxKey{factor} is also required for the math functions. % TODO

\end{docCommand}

\begin{docCommand}
	{nduNewUnitGroup}
	{\marg{unit name}\oarg{key/value pairs}\marg{ordered base units}\oarg{control sequence}}

	In order for the math functions to work, every base unitsin the group must have a conversion path to the right-most base unit, eg. if a unit group consists of base units \texttt{A, B, C}, there must be defined factors for \texttt{A\rightarrow B} and \texttt{B\rightarrow C}. The factor \texttt{A\rightarrow C} is optional; if not configured, an attempt to calculate and cache it will be made internally.

	It is possible to create shortcut macros for commonly used \meta{unit name}s with optional overriding options. These macros take the same arguments as the full \refCom{nduValue} macro, except without the first argument (ie. the name of the unit).
	
	Including too many sub units may make the math results awkward, as the algorithm is greedy. % TODO

\begin{dispExample}
\nduNewUnitGroup{my sletdaler}
	[units/sletdaler/symbol={Sletd.}]
	{sletdaler, ort, skilling}
	[\mySldl]
\mySldl{1.2.3}
\end{dispExample}

\end{docCommand}

\clearpage
\subsection{Options For Base Units}

\begin{docKey}
	[]
	[doc label=units:symbol]
	{units/\meta{unit name}/symbol}
	{=\meta{symbol}}
	{}

	Configures a symbol displaying the unit. This is used in \docAuxCommand{nduHeader} and is also available via \docAuxCommand*{SYMBOL} when defining the \refKey{units:format} (see below).
\end{docKey}

\begin{docKey}
	[]
	[doc label=units:format]
	{units/\meta{unit name}/format}
	{=\marg{prefix}\marg{suffix}}
	{}

	Sets how a given base unit should be formatted for display. If none is given, the general top-level \docAuxKey{format} key is used.
\end{docKey}

\begin{docKey}
	[]
	[doc label=units:factor]
	{units/\meta{unit name}/factor}
	{=\meta{integer} \meta{unit name}}
	{}
	
	The conversion factor of a unit is how many of an underlying unit the given unit consists of. This can be specified multiple times.
	
	This is used by the math macros and keys to calculate the sums and products.
	
	Can be accessed via \refCom{nduFactor}.
\end{docKey}

These keys can of course also be set temporarily in \refCom{nduValue}

\begin{dispExample}
\nduValue{danish rigsdaler}
	[units/mark/symbol=Mk.]
	{.9.}

\nduValue{danish rigsdaler}
	[units/rigsdaler/format={\VALUE~Rigsdaler og}]
	{1.2.3}

\nduValue{danish rigsdaler}[
		unit separator={---},
		units/rigsdaler/format={(\VALUE)},
		units/mark/format={[\VALUE]},
		units/skilling/format={\{\VALUE\}},
	]
	{1.2.3}
\end{dispExample}

\clearpage
\section{Included Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{units:included}
On the following pages are the units included with the package.

\unitlisting{british}

\clearpage
\unitlisting{danish}

\unitlisting{german}

\printindex  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}