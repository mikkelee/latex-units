% !TEX TS-program = LuaLaTeX-shell-escape
\documentclass{article}

\usepackage{non-decimal-units.preamble}

\title{Non-Decimal Units for \LaTeX}
\author{Mikkel Eide Eriksen\\\href{mailto:mikkel.eriksen@gmail.com}{\texttt{mikkel.eriksen@gmail.com}}}

\nduset{
	danish rigsdaler/restrict segment depth=2,
}

\begin{document}

\maketitle

\section{Preface} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Many historical unit systems were non-decimal. For example, the Danish rigsdaler\footnote{\url{https://en.wikipedia.org/wiki/Danish_rigsdaler}} --- where 1 \nduName{danish rigsdaler}{0} consists of \nduFactor{danish rigsdaler}{0} \nduName{danish rigsdaler}{1}, each again consisting of \nduFactor{danish rigsdaler}{1} \nduName{danish rigsdaler}{2} for a total of 96 \nduName{danish rigsdaler}{2} or  per \nduName{danish rigsdaler}{0} --- was used from 1625 to 1875, when currency was decimalised to the current system of 1 krone = 100 øre.

% https://en.wikipedia.org/wiki/Non-decimal_currency

Units for such measures as length, area, weight, and so on were also often non-decimal, and in fact remain so in the few places of the world that have not made the change to the metric system.

The non-decimal numbers were chosen due to their high number of division factors, which simplified mental arithmetic --- eg. when sharing an amount of money or dividing goods.

This package enables creation and configuration of such units to facilitate their presentation in textual and tabular contexts, as well as simple summing.

In order to do this, values are divided into segments, separated by decimal points: The historical Danish monetary value \nduFormatValue{danish rigsdaler}{1.2.3} is entered as \texttt{1.2.3}, which the code then formats it appropriately.

\section{Configuration} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The package is configured in the following manner:

\begin{docCommand}
	{usepackage}
	{\oarg{options}\brackets{non-decimal-units}}

Where \meta{options} may contain one or more of the following unit systems. See \cpageref{units:included} for details.

\begin{description}
\item[british] Currencies
\item[danish] Currencies and areas
\item[german] Currencies
\end{description}

Alternately, one may configure new units via \refCom{nduNewUnit}.

\end{docCommand}

\clearpage
\section{Usage} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Formatting Values} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{docCommand}
	{nduFormatValue}
	{\marg{unit name}\oarg{options}\marg{value}}

Formats \meta{value} according to the setup configured for the \meta{unit name}, as well as any provided \meta{options}. The number of decimal points and the values between them determine how many and which segments are displayed.

Empty segments are skipped.
	
\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduFormatValue} macro
}
\nduFormatValue{danish rigsdaler}{1.2.3}\\
\nduFormatValue{danish rigsdaler}{1..}\\
\nduFormatValue{danish rigsdaler}{.2.}\\
\nduFormatValue{danish rigsdaler}{..3}\\
\end{dispExample*}
\end{docCommand}

\clearpage
\subsubsection{Options}
	
\begin{docKeys}[
		doc name = show,
	]{
		{
			doc parameter = {=values},
		},
		{
			doc parameter = {=values and symbols},
			doc description = initially \texttt{values and symbols},
		},
		{
			doc parameter = {=symbols},
		},
	}

Changes which information is included in the expansion.

Because only those segments with a value will be included, \docAuxKey*{show}=\docValue*{symbols} can be used to list the segment units (though if only one or two is needed, it may be preferable to use \refCom{nduSymbol}).

\begin{dispExample}
\nduFormatValue{danish hartkorn}
	[show=symbols]
	{0.0.0.0.0}

\nduFormatValue{danish hartkorn}
	[show=symbols]
	{0.0...}
\end{dispExample}
\end{docKeys}

See also \cref{units:new} for further discussion on possible options.

\clearpage
\subsection{Tabular Data} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In order to align values in a tabular context, the \docAuxCommand*{nduAlignedHeader} and \docAuxCommand*{nduAlignedValue} macros wrap each segment in a \docAuxCommand*{makebox} of equal width. 

All segments will be included in the headers and cells, whether they contain a value or not. If no value is provided for the segment and no nil replacement is specified with the \refKey{replace nil with} key, the box will be empty.

\begin{docCommand}
	{nduAlignedHeader}
	{\marg{unit name}\oarg{options}}
	Formats the unit symbols in boxes suitable for a header. See \cpageref{units:new} for configuration of symbols.
\end{docCommand}

\begin{docCommand}
	{nduAlignedValue}
	{\marg{unit name}\oarg{options}\marg{value}}
	See \refCom{nduFormatValue} for possible arguments.
\end{docCommand}

\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduAlignedHeader} and \docAuxCommand*{nduAlignedValue} macros
}
\begin{tabular}{r r}
	\toprule
	  & \nduAlignedHeader{danish rigsdaler} \\
	\midrule
	a & \nduAlignedValue{danish rigsdaler}{1.2.3} \\
	b & \nduAlignedValue{danish rigsdaler}{100..} \\
	c & \nduAlignedValue{danish rigsdaler}{.1.} \\
	\bottomrule
\end{tabular}
\end{dispExample*}

\clearpage
\subsubsection{Options}

\begin{docKey}
	{aligned value width}
	{=\meta{length}}
	{initially \texttt{5em}}

Changes the width of each segment.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{aligned value width} key
}
\begingroup
\nduset{
	aligned value width=3em,
}
\begin{tabular}{r r}
	\toprule
	& \nduAlignedHeader{danish rigsdaler} \\
	\midrule
	a & \nduAlignedValue{danish rigsdaler}{1.2.3} \\
	b & \nduAlignedValue{danish rigsdaler}{100..} \\
	c & \nduAlignedValue{danish rigsdaler}{.1.} \\
	\bottomrule
\end{tabular}
\endgroup
\end{dispExample*}
\end{docKey}

\begin{docKey}
	{replace nil with}
	{=\meta{...}}
	{no default, initially empty}

Replaces nil (empty) segments with a string.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{replace nil with} key
}
\begingroup
\nduset{
	replace nil with=---,
}
\begin{tabular}{r r}
	\toprule
	& \nduAlignedHeader{danish rigsdaler} \\
	\midrule
	a & \nduAlignedValue{danish rigsdaler}{1.2.3} \\
	b & \nduAlignedValue{danish rigsdaler}{100..} \\
	c & \nduAlignedValue{danish rigsdaler}{.1.} \\
	\bottomrule
\end{tabular}
\endgroup
\end{dispExample*}
\end{docKey}

\clearpage
\subsection{Arithmetical Operations} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Basic arithmetic functions can be used to build a result for display. Internally, this is done by converting the value to a representation, which is the total number of the smallest usable unit, eg. \nduFormatValue{danish rigsdaler}{1.2.3} is 131 \nduName{danish rigsdaler}{2}.

Results can be gathered in two ways, either manually via the \docAuxCommand*{nduMath} macro, or automatically via the \docAuxKey*{sum to} key, the latter being especially suitable in tabular contexts.

\begin{docCommands}[]{
	{
		doc name = nduMath,
		doc parameter = \marg{unit name}\oarg{options}\marg{result name}\marg{value}
	},
	{
		doc name = nduFormatResult,
		doc parameter = \marg{unit name}\oarg{options}\marg{result name}
	},
	{
		doc name = nduAlignedResult,
		doc parameter = \marg{unit name}\oarg{options}\marg{result name}
	}
}

The arguments of \docAuxCommand*{nduMath} are identical to those of the \refCom{nduFormatValue} macro, except for the addition of the \meta{result name} argument, under which the result will be accumulated. It does not expand to any output. The first time a result name is used, it is assumed that the value is 0.

The \docAuxCommand*{nduFormatResult} macro takes the \meta{result name} and formats it for display in the same way as \refCom{nduFormatValue}.

Likewise, \docAuxCommand*{nduAlignedResult} macro formats a result in the same way as \refCom{nduAlignedValue}.

All three may be further configured via the \meta{options} in the same way as the regular macros.

\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduMath} and \docAuxCommand*{nduFormatResult} macros
}
\nduMath{danish rigsdaler}{example 1}{+}{0.0.10}
\nduMath{danish rigsdaler}{example 1}{+}{..8}
\nduMath{danish rigsdaler}{example 1}{+}{0.2}
\nduMath{danish rigsdaler}{example 1}{+}{0.5.1}
\nduFormatResult{danish rigsdaler}{example 1} % = 1.2.3
\end{dispExample*}

\begin{dispExample*}{
	title=Example usage: \docAuxCommand*{nduAlignedResult} macro
}
\nduAlignedHeader{danish rigsdaler}\\
\nduAlignedResult{danish rigsdaler}{example 1}
\end{dispExample*}
\end{docCommands}

\clearpage
\subsubsection{Options}

\begin{docKey}
	{sum to}
	{=\meta{name}}
	{initially empty}

Setting this key will cause all uses of \docAuxCommand*{nduFormatValue} and \docAuxCommand*{nduAlignedValue} in the current group to be summed under the given name.

\begin{dispExample*}{
	title=Example usage: \docAuxKey*{sum to} key
}
\begingroup
\nduset{
	aligned value width=3em,
	replace nil with=---,
	sum to=example 2
}
\begin{tabular}{r r}
	\toprule
	& \nduAlignedHeader{danish rigsdaler} \\
	\midrule
	a & \nduAlignedValue{danish rigsdaler}{1.2.3} \\
	b & \nduAlignedValue{danish rigsdaler}{100.1.} \\
	\bottomrule
	total & \nduAlignedResult{danish rigsdaler}{example 2} \\ % = 101.3.3
\end{tabular}
\endgroup
\end{dispExample*}

Results are global and remain accessible outside the group:
\begin{dispExample}
\nduFormatResult{danish rigsdaler}{example 2}
\end{dispExample}

Adding an additional 15 \nduName{danish rigsdaler}{2} to the existing result gives:
\begin{dispExample}
\nduMath{danish rigsdaler}{example 2}{+}{0.0.15}
\nduFormatResult{danish rigsdaler}{example 2} % = 101.4.2
\end{dispExample}
\end{docKey}

\subsection{Accessing Information About Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{docCommand}
	{nduName}
	{\marg{unit name}\marg{segment}}
	Expands to the name of the the given segment of the unit.
	
	Set by \refKey{segment:name}.
\end{docCommand}

\begin{docCommand}
	{nduSymbol}
	{\marg{unit name}\marg{segment}}
	Expands to the symbol of the the given segment of the unit.
	
	Set by \refKey{segment:symbol}.
\end{docCommand}

\begin{docCommand}
	{nduFactor}
	{\marg{unit name}\marg{segment}}
	Expands to the conversion factor of the the given segment of the unit, ie. how many of the underlying segment the given segment consists of.

\begin{dispExample}
That is, 1 \nduName{danish rigsdaler}{0} consists of
\nduFactor{danish rigsdaler}{0} \nduName{danish rigsdaler}{1}.
\end{dispExample}
\end{docCommand}

\section{Creating New Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{units:new}
If the included units are not suitable, more can be created. Pull requests are also welcome at \url{https://github.com/mikkelee/latex-units}.

\begin{docCommand}
	{nduNewUnit}
	{\marg{unit name}\marg{key/value pairs}}
	
Units can have up to 5 segments, numbered \meta{0-4}. The left-most segment, that is, the \emph{top} or \emph{root} segment, is numbered \texttt{0}.

The numeral part of the below key paths \docAuxKey*{segment 0/} can be any integer up to \texttt{4}, ie. \docAuxKey*{segment 4/}. The internal number of segments is determined by how many name keys are created.

See below for available settings.

\end{docCommand}

\begin{docCommand}
	{nduNewMacro}
	{\marg{unit name}\oarg{key/value pairs}\marg{control sequence}}

	It is possible to create shortcut macros for commonly used \meta{unit name}s with optional overriding options.

	These macros take the same arguments as the full \refCom{nduFormatValue} macro, except without the first argument (ie. the name of the unit).

\begin{dispExample}
\nduNewMacro{danish rigsdaler}
	[segment 0/symbol={R\textsuperscript{dl}}]
	{myRdl}
\myRdl{1.2.3}
\end{dispExample}

\end{docCommand}

\begin{docCommand}
	{nduCommonSymbols}
	{\marg{key/value pairs}}

	It is possible to configure commonly used symbols using the form \texttt{\meta{name}=\meta{symbol}}. These will be used as fallbacks if no specific symbol is configured for a segment via \refKey{segment:symbol}.

\end{docCommand}

\subsubsection{Options}

\begin{docKey}
	{segment separator}
	{=\meta{...}}
	{initially \texttt{\~{}}}
	
	When displaying a value, this string will be inserted between each segment.

\begin{dispExample}
\nduFormatValue{danish hartkorn}[
		show=values,
		segment separator=.
	]
	{1.2.3.4}

\nduFormatValue{danish rigsdaler}
	[segment separator={---}]
	{1.2.3}
\end{dispExample}

\end{docKey}

\begin{docKey}
	{restrict segment depth}
	{=\meta{integer}}
	{initially no restriction}
	
	When calculating or displaying a value, only the segments up to and including \meta{integer} will be considered.
	
	In this document, the depth has been globally set to \texttt{2} for \docAuxKey*{danish rigsdaler}, but the older historical sub-unit \nduName{danish rigsdaler}{3} can be included by locally setting the depth to \texttt{3} (or indeed not restricting it globally).
	
\begin{dispExample}
\nduFormatValue{danish rigsdaler}
	[restrict segment depth=3]
	{1.2.3.4}
\end{dispExample}
\end{docKey}

\begin{docKey}
	[]
	[doc label=segment:name]
	{segment \meta{n}/name}
	{=\meta{name}}
	{no default, initially undefined}

	Gives the proper name of the segment's unit. Used internally to determine how many segments the unit contains.
	
	Can be accessed with by \refCom{nduName}.
\end{docKey}

\begin{docKey}
	[]
	[doc label=segment:symbol]
	{segment \meta{n}/symbol}
	{=\meta{symbol}}
	{no default, initially undefined}

	Configures a symbol displaying the unit. This is used in \docAuxCommand{nduAlignedHeader} and is also available via \docAuxCommand{nduSym} when defining the \refKey{segment:display} (see below).
	
	If none is configured, an attempt to look up a common symbol by its name is made. These can be configured with \refCom{nduCommonSymbols}.
\end{docKey}

\begin{docKey}
	[]
	[doc label=segment:display]
	{segment \meta{n}/display}
	{=\marg{prefix}\marg{suffix}}
	{initially \texttt{\{\}\{ \docAuxCommand*{nduSym}\}}}

	When displaying a value, the segments will be wrapped between the \meta{prefix} and \meta{suffix}.
	
	The macro \docAuxCommand{nduSym} is available here to show the symbol configured for the segment.
	
	The default is to use the symbol as prefix, but can be overriden if necessary.
\end{docKey}

\begin{docKey}
	[]
	[doc label=segment:factor]
	{segment \meta{n}/factor}
	{=\meta{integer}}
	{no default, initially undefined}
	
	The conversion factor of a segment is how many of the underlying segment the given segment consists of.
	
	This is used in the math macros, in order to calculate the correct segment values.
	
	Can be accessed via \refCom{nduFactor}.
\end{docKey}

These keys can of course also be set temporarily in \refCom{nduFormatValue}

\begin{dispExample}
\nduFormatValue{danish rigsdaler}
	[segment 1/symbol=Mk.]
	{.9.}

\nduFormatValue{danish rigsdaler}
	[segment 0/display={}{ Rigsdaler og}]
	{1.2.3}

\nduFormatValue{danish rigsdaler}[
		segment separator={---},
		segment 0/display={(}{)},
		segment 1/display={[}{]},
		segment 2/display={\{}{\}},
	]
	{1.2.3}
\end{dispExample}

\begin{docKey}
	{create macro named}
	{=\meta{control sequence}}
	{no default, initially empty}
	
	Units may provide a default shortcut macro, for example the \docValue*{danish rigsdaler} unit configures \docAuxCommand*{rdl}.
	
	This is done via \refCom{nduNewMacro} which describes the arguments of the resulting macros.

\begin{dispExample*}{
	sidebyside,
	righthand width=1.75cm,
}
\rdl{2.3.}
\end{dispExample*}
\end{docKey}

\clearpage
\section{Included Units} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{units:included}
On the following pages are the units included with the package.

\unitlisting{british}

\clearpage
\unitlisting{danish}

\unitlisting{german}

\printindex  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}