\documentclass{article}

\ExplSyntaxOn


\keys_define:nn { non-decimal-units }
{
	replace~nil~with 	.tl_set:N		= \l_ndu_replace_nil_with_tl ,
	treat~zero~as~nil 	.bool_set:N 	= \l_ndu_treat_zero_as_nil_bool ,
	treat~zero~as~nil 	.default:n 		= true ,
	segment~separator 	.tl_set:N		= \l_ndu_segment_separator_tl ,
	segment~separator	.default:n		= { ~ } ,
	default~format		.tl_set:N		= \l_ndu_default_format_tl ,
	default~format		.default:n		= { \VALUE\ \SYMBOL } ,
	normalize 			.bool_set:N		= \l_ndu_normalize_bool ,
	normalize 			.default:n 		= true ,
	aligned				.bool_set:N		= \l_ndu_aligned_bool ,
	aligned				.default:n 		= true ,
	cell~width			.dim_set:N		= \l_ndu_cell_width_dim ,
	cell~width 			.default:n 		= 3em ,
}
\keys_set:nn { non-decimal-units } {
	segment~separator,
	default~format,
}

%\NewDocumentCommand { \nduNewBaseUnit } { m m }
%{
%	\keys_define:nn { non-decimal-units / # 1}
%	{
%		name					.tl_set:c		= { l_ndu_ #1 _name_tl } ,
%		format					.tl_set:n		= { \VALUE\ \SYMBOL } ,
%	}
%}
%
%\NewDocumentCommand { \nduNewUnitSegment } { m m }
%{
%	\keys_define:nn { non-decimal-units }
%	{
%		#1 / segment~#2 / name			.tl_set:c		= { l_ndu_#1_#2_name_tl } ,
%		#1 / segment~#2 / factor		.tl_set:c		= { l_ndu_#1_#2_factor_tl } ,
%		#1 / segment~#2 / symbol		.tl_set:c		= { l_ndu_#1_#2_symbol_tl } ,
%		#1 / segment~#2 / display		.tl_set:c		= { l_ndu_#1_#2_display_tl } ,
%	}
%}

\int_new:N \__l_ndu_tmpa_int
\int_new:N \__l_ndu_tmpb_int
\int_new:N \__l_ndu_tmpc_int
\int_new:N \__l_ndu_tmpd_int

\tl_new:N \__l_ndu_tmpa_tl
\tl_new:N \__l_ndu_tmpb_tl
\tl_new:N \__l_ndu_tmpc_tl
\tl_new:N \__l_ndu_tmpd_tl


\seq_const_from_clist:Nn \l_ndu_units_seq {
	rigsdaler ,
	mark ,
	skilling,
	hvid
}

\tl_new:N \l_ndu_base_unit_tl
\tl_set:Nn \l_ndu_base_unit_tl { hvid }


\cs_new_protected:Npn \ndu_define_factor:nnn #1#2#3
{
	\int_new:c { l_ndu_factor_#1_#2_int }
	\int_gset:cn { l_ndu_factor_#1_#2_int } { #3 }
}


\ndu_define_factor:nnn { rigsdaler } \l_ndu_base_unit_tl { 288 }
\ndu_define_factor:nnn { mark } \l_ndu_base_unit_tl { 48 }
\ndu_define_factor:nnn { skilling } \l_ndu_base_unit_tl { 3 }
\ndu_define_factor:nnn { hvid } \l_ndu_base_unit_tl { 1 }


\cs_new_protected:Npn \ndu_define_symbol:nn #1#2
{
	\tl_new:c { l_ndu_symbol_#1_tl }
	\tl_gset:cn { l_ndu_symbol_#1_tl } { #2 }
}

\ndu_define_symbol:nn { rigsdaler } { Rdl. }
\ndu_define_symbol:nn { mark } { Mk. }
\ndu_define_symbol:nn { skilling } { Sk. }
\ndu_define_symbol:nn { hvid } { Hv. }




\cs_new_protected:Npn \ndu_repr_to_seq:nnnnn #1#2#3#4#5
{
	% parameters
	% #1: unit sequence (seq)
	% #2: base unit (tl)
	% #3: amount (int)
	% #4: unit (tl)
	% #5: output result (seq)
	% scratch vars:
	\seq_clear:N #5
	% \__l_ndu_tmpa_int: remaining amount
	% \__l_ndu_tmpb_int: current factor
	% \__l_ndu_tmpc_int: current amount of that factor
	% \__l_ndu_tmpd_int: loop index

	% init amount * base factor
	\int_set:Nn \__l_ndu_tmpa_int {#3 * \int_use:c { l_ndu_factor_#4_#2_int } }

	% for i, (name, factor) in enumerate(units):
	\seq_map_inline:Nn #1 {
		\int_set:Nn \__l_ndu_tmpb_int { \int_use:c { l_ndu_factor_##1_#2_int } }
		\int_set:Nn \__l_ndu_tmpc_int 0

		% while (amount >= factor):
		\int_while_do:nn {\__l_ndu_tmpa_int >= \__l_ndu_tmpb_int} {
			% amount -= factor
			\int_sub:Nn \__l_ndu_tmpa_int \__l_ndu_tmpb_int
			% result[i] += 1
			\int_incr:N \__l_ndu_tmpc_int
		}
		\seq_put_right:Nx #5 {\int_use:N \__l_ndu_tmpc_int}
		
		% stop when we hit the desired unit depth
		\str_if_eq:NNT {##1} {#4} {
			\seq_map_break:
		}
	}
}



\cs_new_protected:Npn \ndu_seq_to_repr:nnnn #1#2#3#4
{
	% parameters
	% #1: unit sequence (seq)
	% #2: base unit (tl)
	% #3: input (seq)
	% #4: output result (int)
	% scratch vars
	% \__l_ndu_tmpa_tl: current amount
	\int_zero:N #4

	\seq_map_indexed_inline:Nn #1
	{
		\tl_set:Nx \__l_ndu_tmpa_tl { \seq_item:Nn #3 {##1} }
		\tl_if_blank:VF \__l_ndu_tmpa_tl {
			\int_add:Nn #4 { \__l_ndu_tmpa_tl * \int_use:c { l_ndu_factor_##2_#2_int }  }
		}
	}
}



% placeholder tokens for \ndu_format_helper
\tl_new:N \VALUE
\tl_new:N \SYMBOL

\cs_new_protected:Npn \ndu_format_helper:nnnn #1#2#3#4
{
	% parameters
	% #1: format (tl)
	% #2: symbol (tl)
	% #3: amount (int)
	% #4: output result (tl)
    \tl_set:Nn #4 { #1 }
    \tl_replace_all:Nnn #4 { \VALUE } { #2 }
    \tl_replace_all:Nnn #4 { \SYMBOL } { #3 }
}

\cs_new_protected:Npn \ndu_format_seq:nnn #1#2#3
{
	% parameters
	% #1: unit sequence (seq)
	% #2: amount sequence (seq)
	% #3: output result (seq)
	% scratch vars:
	% \__l_ndu_tmpa_int: loop index
	% \l_tmpa_tl: current value
	% \__l_ndu_tmpa_tl: formatted segment
	% \l_tmpa_seq: all formatted segments
	\seq_clear:N #3

	\seq_map_indexed_inline:Nn #2
	{
		\tl_if_blank:nTF {##2}
		{
			\tl_if_empty:NF {\l_ndu_replace_nil_with_tl}
			{
				\ndu_format_helper:nnnn
					{ \VALUE\ \SYMBOL } % TODO
					{ \l_ndu_replace_nil_with_tl }
					{ \tl_use:c { l_ndu_symbol_ \seq_item:Nn #1 ##1 _tl } }
					\__l_ndu_tmpa_tl
				\seq_put_right:Nx #3 { \__l_ndu_tmpa_tl }
			}
		}
		{
			\bool_set:Nn \l_tmpa_bool { 
				\l_ndu_treat_zero_as_nil_bool &&
				\int_compare_p:n { ##2 = 0 }
			}
			\bool_if:NTF \l_tmpa_bool {
				\tl_if_empty:NF {\l_ndu_replace_nil_with_tl}
				{
					\ndu_format_helper:nnnn
						{ \VALUE\ \SYMBOL } % TODO
						{ \l_ndu_replace_nil_with_tl }
						{ \tl_use:c { l_ndu_symbol_ \seq_item:Nn #1 ##1 _tl } }
						\__l_ndu_tmpa_tl
					\seq_put_right:Nx #3 { \__l_ndu_tmpa_tl }
				}
			}
			{
				\ndu_format_helper:nnnn
					{ \VALUE\ \SYMBOL } % TODO
					{ ##2 }
					{ \tl_use:c { l_ndu_symbol_ \seq_item:Nn #1 ##1 _tl } }
					\__l_ndu_tmpa_tl
				\seq_put_right:Nx #3 { \__l_ndu_tmpa_tl }
			}
		}
	}
}

\cs_new_protected:Npn \ndu_format_value:nnnn #1#2#3#4
{
	% parameters
	% #1: unit sequence (seq)
	% #2: amount sequence (seq)
	% #3: separator (tl)
	% #4: output result (tl)
	\seq_clear:N \l_tmpa_seq
	\ndu_format_seq:nnn {#1} {#2} \l_tmpa_seq
	\tl_set:Nn #4 { \seq_use:Nn \l_tmpa_seq {#3} }
}

\cs_new_protected:Npn \ndu_format_value_aligned:nnnn #1#2#3#4
{
	% parameters
	% #1: unit sequence (seq)
	% #2: amount sequence (seq)
	% #3: cell width (dim)
	% #4: output result (tl)
	\tl_clear:N #4
	\seq_clear:N \l_tmpa_seq
	\ndu_format_seq:nnn {#1} {#2} \l_tmpa_seq

	\seq_map_indexed_inline:Nn \l_tmpa_seq {
		\box_clear_new:c { __l_ndu_cell_ \int_to_alph:n {##1} _box }
		\hbox_set_to_wd:cnn { __l_ndu_cell_ \int_to_alph:n {##1} _box } {#3} { \hfill ##2 }
		\tl_put_right:Nx #4 { \box_use:c { __l_ndu_cell_ \int_to_alph:n {##1} _box } }
	}
}

\NewDocumentCommand \nduValue { o m } {
	\tl_clear_new:N \__l_ndu_result_tl
	\int_zero_new:N \__l_ndu_normalized_int
	\group_begin:
		\IfValueT {#1} { \keys_set:nn { non-decimal-units } { #1 } }

		\seq_set_split:Nnn \l_tmpb_seq { . } {#2}
		\bool_if:nT \l_ndu_normalize_bool
		{
			\ndu_seq_to_repr:nnnn \l_ndu_units_seq \l_ndu_base_unit_tl \l_tmpb_seq \__l_ndu_normalized_int
			\ndu_repr_to_seq:nnnnn \l_ndu_units_seq \l_ndu_base_unit_tl \__l_ndu_normalized_int \l_ndu_base_unit_tl \l_tmpb_seq
		}

		\bool_if:NTF \l_ndu_aligned_bool
		{
			\ndu_format_value_aligned:nnnn \l_ndu_units_seq \l_tmpb_seq \l_ndu_cell_width_dim \__l_ndu_result_tl
		}
		{
			\ndu_format_value:nnnn \l_ndu_units_seq \l_tmpb_seq \l_ndu_segment_separator_tl \__l_ndu_result_tl
		}
		\tl_use:N \__l_ndu_result_tl
	\group_end:
}



\ExplSyntaxOff

\begin{document}

4.3.2.1: \nduValue[]{4.3.2.1}

.1.: \nduValue{.1.}

1..1: \nduValue[segment separator={,}]{1..1}

1.2.3: \nduValue{1.2.3}

1.0.1: \nduValue[treat zero as nil]{1.0.1}

normalize:

..100: \nduValue{..100}

..100: \nduValue[normalize]{..100}

..100: \nduValue[normalize, treat zero as nil]{..100}

aligned:

1.2.3: \nduValue[aligned, cell width=5em]{1.2.3}

1..3: \nduValue[aligned, cell width=5em, replace nil with={---}]{1..3}


\end{document}
